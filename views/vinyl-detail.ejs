<%- include('partials/header') %>

<div class="max-w-screen-xl mx-auto px-4 pb-20">
    
    <nav class="flex py-6 text-sm text-neutral-500 dark:text-neutral-400 transition-colors">
        <a href="/collection" class="hover:text-green-600 dark:hover:text-green-400 transition-colors flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i> <%= t('detail.back_to_collection') %>
        </a>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        
        <div class="lg:col-span-6 flex flex-col items-center">
            <div class="relative w-full max-w-lg aspect-square bg-gray-100 dark:bg-neutral-900 rounded-2xl border border-neutral-200 dark:border-neutral-800 shadow-xl dark:shadow-2xl overflow-hidden flex items-center justify-center group transition-colors">
                
                <img id="mainImage" 
                     src="<%= album.user_image || album.cover_image %>" 
                     class="w-full h-full object-contain transition-transform duration-300 group-hover:scale-[1.02]" 
                     alt="Album Visual">

                <span id="imageBadge" class="absolute top-4 right-4 bg-white/90 dark:bg-black/60 backdrop-blur-md text-neutral-900 dark:text-white text-xs px-3 py-1 rounded-full border border-neutral-200 dark:border-white/10 shadow-sm transition-colors">
                    <%= album.user_image ? t('detail.additional_image') : t('detail.official_cover') %>
                </span>
            </div>

            <div class="flex gap-4 mt-6 overflow-x-auto pb-2 w-full max-w-lg justify-center">
                <% if (album.user_image) { %>
                    <button onclick="switchImage('<%= album.user_image %>', '<%= t('detail.additional_image') %>')" 
                            class="thumb-btn w-20 h-20 rounded-lg border-2 border-green-500 overflow-hidden relative transition-all hover:opacity-100 focus:outline-none shadow-md">
                        <img src="<%= album.user_image %>" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/10 dark:bg-black/20"></div>
                    </button>
                <% } %>

                <button onclick="switchImage('<%= album.cover_image %>', '<%= t('detail.official_cover') %>')" 
                        class="thumb-btn w-20 h-20 rounded-lg border-2 border-transparent hover:border-neutral-400 dark:hover:border-neutral-500 overflow-hidden relative transition-all opacity-70 hover:opacity-100 focus:outline-none shadow-sm">
                    <img src="<%= album.cover_image %>" class="w-full h-full object-cover">
                </button>
            </div>
        </div>

        <div class="lg:col-span-6 space-y-8">
            <div>
                <h1 class="text-3xl md:text-5xl font-black text-neutral-900 dark:text-white mb-2 leading-tight transition-colors"><%= album.title %></h1>
                <h2 class="text-xl md:text-2xl text-green-600 dark:text-green-400 font-semibold mb-4 transition-colors"><%= album.artist %></h2>
                
                <div class="flex flex-wrap gap-2">
                    <% 
                        let badgeColor = 'bg-green-600 text-white';
                        let badgeText = t('media.vinyl');
                        if (album.media_type === 'cd') {
                            badgeColor = 'bg-blue-600 text-white';
                            badgeText = t('media.cd');
                        } else if (album.media_type === 'cassette') {
                            badgeColor = 'bg-orange-600 text-white';
                            badgeText = t('media.cassette');
                        }
                    %>
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider <%= badgeColor %> shadow-sm">
                        <%= badgeText %>
                    </span>

                    <% if (album.year) { %>
                        <span class="px-3 py-1 bg-gray-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-full text-xs text-neutral-700 dark:text-white transition-colors">
                            <%= album.year %>
                        </span>
                    <% } %>
                    <span class="px-3 py-1 bg-gray-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-full text-xs text-neutral-700 dark:text-white transition-colors">
                        <%= album.format_type %>
                    </span>
                    <% if(album.variant_color) { %>
                        <span class="px-3 py-1 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700/50 text-green-700 dark:text-green-400 rounded-full text-xs flex items-center gap-2 transition-colors">
                            <i class="fa-solid fa-palette"></i> <%= album.variant_color %>
                        </span>
                    <% } %>
                </div>
            </div>

            
            <div class="flex flex-col ml-2">
                <span class="text-[10px] uppercase tracking-widest text-neutral-500 dark:text-neutral-400 font-bold mb-1">
                    <%= t('common.location') %>
                </span>
                <span class="text-sm text-neutral-900 dark:text-white font-medium">
                    <i class="fa-solid fa-box-archive mr-2 text-neutral-400"></i>
                    <%= album.location || t('common.not_specified') %>
                </span>
            </div>


            <div class="bg-white dark:bg-neutral-900/50 rounded-xl p-6 border border-neutral-200 dark:border-neutral-800 grid grid-cols-2 gap-y-6 gap-x-4 transition-colors shadow-sm dark:shadow-none">
                <div>
                    <span class="block text-xs text-neutral-500 uppercase font-bold mb-1"><%= t('confirm_vinyl.label_label') %></span>
                    <span class="text-neutral-900 dark:text-white font-medium transition-colors"><%= album.label || 'N/A' %></span>
                </div>
                <div>
                    <span class="block text-xs text-neutral-500 uppercase font-bold mb-1"><%= t('confirm_vinyl.catalog_label') %></span>
                    <span class="text-neutral-700 dark:text-white font-mono text-sm bg-gray-100 dark:bg-neutral-800 px-2 py-1 rounded transition-colors"><%= album.catalog_number || 'N/A' %></span>
                </div>
                <div>
                    <span class="block text-xs text-neutral-500 uppercase font-bold mb-1"><%= t('detail.added_at') %></span>
                    <span class="text-neutral-900 dark:text-white transition-colors"><%= new Date(album.added_at).toLocaleDateString(currentLng === 'fr' ? 'fr-FR' : 'en-US') %></span>
                </div>
                <div>
                    <span class="block text-xs text-neutral-500 uppercase font-bold mb-1"><%= t('detail.source') %></span>
                    <a href="https://www.discogs.com/release/<%= album.discogs_id %>" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-sm inline-flex items-center gap-1 transition-colors">
                        Discogs <i class="fa-solid fa-external-link-alt text-[10px]"></i>
                    </a>
                </div>
            
                <div class="col-span-2 border-t border-neutral-200 dark:border-neutral-800 mt-2 pt-4 transition-colors">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-neutral-500 uppercase font-bold"><%= t('detail.estimation_title') %></span>
                        <button id="btnEstimate" onclick="fetchEstimation('<%= album.discogs_id %>')" class="text-xs bg-gray-100 dark:bg-neutral-800 hover:bg-green-600 hover:text-white text-neutral-700 dark:text-white px-2 py-1 rounded transition-colors flex items-center gap-1 border border-neutral-200 dark:border-neutral-700">
                            <i class="fa-solid fa-calculator"></i> <%= t('detail.calculate_btn') %>
                        </button>
                    </div>
                    <div id="priceResult" class="hidden text-sm"></div>
                    <div id="priceLoader" class="hidden text-center py-2 text-neutral-500 text-xs italic">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> <%= t('detail.market_analysis') %>
                    </div>
                </div>
            </div>

            <% if (album.comments) { %>
                <div class="bg-yellow-50 dark:bg-neutral-800/30 rounded-xl p-6 border border-yellow-100 dark:border-neutral-800 relative overflow-hidden transition-colors">
                    <div class="absolute -right-2 -top-2 text-yellow-500/10 dark:text-neutral-800 text-6xl opacity-50 dark:opacity-100">
                        <i class="fa-solid fa-quote-right"></i>
                    </div>
                    <h3 class="text-xs uppercase font-bold text-neutral-500 dark:text-neutral-500 mb-3 flex items-center gap-2 relative z-10">
                        <i class="fa-regular fa-comment-dots"></i> <%= t('detail.personal_notes') %>
                    </h3>
                    <p class="text-neutral-700 dark:text-neutral-300 text-sm leading-relaxed whitespace-pre-line relative z-10 transition-colors">
                        <%= album.comments %>
                    </p>
                </div>
            <% } %>

            <div>
                <h3 class="text-lg font-bold text-neutral-900 dark:text-white mb-4 flex items-center gap-2 transition-colors">
                    <i class="fa-solid fa-list-ul text-neutral-500"></i> <%= t('detail.tracklist_title') %>
                </h3>
                
                <div class="bg-white dark:bg-neutral-900 rounded-xl border border-neutral-200 dark:border-neutral-800 overflow-hidden shadow-sm dark:shadow-none transition-colors">
                    <% if(album.tracklist && album.tracklist.length > 0) { %>
                        <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left text-sm text-neutral-600 dark:text-neutral-400">
                                <thead class="bg-gray-100 dark:bg-neutral-950 text-xs uppercase text-neutral-500 sticky top-0 z-10 transition-colors">
                                    <tr>
                                        <th class="px-4 py-3 w-14 text-center">#</th>
                                        <th class="px-4 py-3"><%= t('confirm_vinyl.field_title') %></th>
                                        <th class="px-4 py-3 text-right"><%= t('confirm_vinyl.year_label') === 'Année' ? 'Durée' : 'Duration' %></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-neutral-200 dark:divide-neutral-800 transition-colors">
                                    <% album.tracklist.forEach(track => { %>
                                        <tr class="hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors">
                                            <td class="px-4 py-3 text-center font-mono text-green-600 font-bold opacity-70"><%= track.position %></td>
                                            <td class="px-4 py-3 text-neutral-900 dark:text-white font-medium transition-colors"><%= track.title %></td>
                                            <td class="px-4 py-3 text-right font-mono text-xs"><%= track.duration %></td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="p-6 text-center text-neutral-500 italic"><%= t('detail.no_tracks') %></p>
                    <% } %>
                </div>
            </div>
            
            <% if (user.isAdmin) { %>
                <div class="pt-6 border-t border-neutral-200 dark:border-neutral-800 flex justify-end gap-4 transition-colors">
                    <a href="/edit/<%= album._id %>" class="text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white px-4 py-2 text-sm transition-colors border border-neutral-300 dark:border-neutral-700 rounded-lg hover:bg-gray-100 dark:hover:bg-neutral-800">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> <%= t('common.edit') %>
                    </a>
                    <button onclick="confirmDelete('<%= album._id %>')" class="text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400 bg-red-100 dark:bg-red-500/10 hover:bg-red-200 dark:hover:bg-red-500/20 px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fa-solid fa-trash mr-2"></i> <%= t('admin.tooltips.delete') %>
                    </button>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    const translations = {
        official_cover: "<%= t('detail.official_cover') %>",
        additional_image: "<%= t('detail.additional_image') %>",
        confirm_delete: "<%= t('detail.confirm_delete') %>",
        market_price: "<%= t('detail.market_price') %>",
        historical_estimate: "<%= t('detail.historical_estimate') %>",
        shipping_hint: "<%= t('detail.shipping_hint') %>",
        view_discogs: "<%= t('detail.view_discogs') %>",
        unavailable_data: "<%= t('detail.unavailable_data') %>",
        analyzing: "<%= t('detail.market_analysis') %>",
        error_server: "<%= t('messages.generic_error') %>"
    };

    const currentLocale = '<%= currentLng === "fr" ? "fr-FR" : "en-US" %>';

    function switchImage(url, text) {
        const mainImg = document.getElementById('mainImage');
        const badge = document.getElementById('imageBadge');
        
        mainImg.style.opacity = '0.5'; 
        
        setTimeout(() => {
            mainImg.src = url;
            badge.innerText = text;
            mainImg.style.opacity = '1';
        }, 150);

        document.querySelectorAll('.thumb-btn').forEach(btn => {
            btn.classList.remove('border-green-500', 'opacity-100', 'ring-2', 'ring-green-500/50');
            btn.classList.add('border-transparent', 'opacity-70');
            
            if(btn.querySelector('img').src === url) {
                btn.classList.remove('border-transparent', 'opacity-70');
                btn.classList.add('border-green-500', 'opacity-100', 'ring-2', 'ring-green-500/50');
            }
        });
    }

    async function confirmDelete(id) {
        if (confirm(translations.confirm_delete)) {
            try {
                const response = await fetch(`/api/album/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = data.redirectUrl;
                } else {
                    alert(`${translations.error_server}: ${data.error}`);
                }
            } catch (err) {
                console.error(err);
                alert(translations.error_server);
            }
        }
    }

    async function fetchEstimation(id) {
        const btn = document.getElementById('btnEstimate');
        const resultDiv = document.getElementById('priceResult');
        const loader = document.getElementById('priceLoader');
        
        btn.classList.add('hidden');
        loader.classList.remove('hidden');

        try {
            const res = await fetch(`/api/estimate/${id}`);
            const data = await res.json();

            if (data.success && data.price) {
                const fmtPrice = new Intl.NumberFormat(currentLocale, { 
                    style: 'currency', 
                    currency: data.price.currency 
                }).format(data.price.value);

                const isMarket = data.source === 'market';
                const labelText = isMarket ? translations.market_price : translations.historical_estimate;
                const colorClass = isMarket ? "text-green-600 dark:text-green-400" : "text-blue-600 dark:text-blue-400";
                const icon = isMarket ? '<i class="fa-solid fa-shop mr-1"></i>' : '<i class="fa-solid fa-history mr-1"></i>';

                resultDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-4 bg-gray-50 dark:bg-neutral-900/50 rounded-lg border border-neutral-200 dark:border-neutral-800 mt-2 transition-colors">
                        <span class="text-[10px] text-neutral-500 uppercase font-bold mb-1 flex items-center">
                            ${icon} ${labelText}
                        </span>
                        <span class="text-3xl font-black ${colorClass} mb-1 transition-colors">${fmtPrice}*</span>
                        <span class="text-xs text-neutral-500 dark:text-neutral-400 mb-1 transition-colors">${data.details}</span>
                        <span class="text-[9px] text-neutral-400 dark:text-neutral-600 mb-2 transition-colors">
                            ${translations.shipping_hint}
                        </span>
                        <a href="https://www.discogs.com/release/${id}" target="_blank" class="text-xs text-neutral-500 hover:text-neutral-900 dark:hover:text-white underline transition-colors">
                            ${translations.view_discogs}
                        </a>
                    </div>
                `;

                loader.classList.add('hidden');
                resultDiv.classList.remove('hidden');
            }
        } catch (err) {
            loader.innerHTML = `<span class="text-neutral-500 text-xs italic">${translations.unavailable_data}</span>`;
            setTimeout(() => {
                loader.classList.add('hidden');
                loader.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${translations.analyzing}`;
                btn.classList.remove('hidden');
            }, 3000);
        }
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f5; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4d4d4; border-radius: 3px; }

    .dark .custom-scrollbar::-webkit-scrollbar-track { background: #171717; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }
</style>

<%- include('partials/footer') %>